#!/bin/sh

# System turning
sysctl -w vm.dirty_background_bytes=67108864 > /dev/null 2>&1
sysctl -w vm.dirty_bytes=134217728 > /dev/null 2>&1

log() {
  local message="$1"
  echo "[INFO] $message"
}

readonly PATRONI_CONFIG_PATH="${PATRONI_CONFIG_PATH:-/opt/postgres/config/postgres.yml}"
readonly PATRONI_SCOPE="${PATRONI_SCOPE:-batman}"
DOCKER_IP=$(hostname -i)
readonly DOCKER_IP

# Patroni options
export PATRONI_SCOPE
export PATRONI_NAME="${PATRONI_NAME:-$(hostname)}"
export PATRONI_POSTGRESQL_DATA_DIR="${PATRONI_POSTGRESQL_DATA_DIR:-$PGDATA}"
export PATRONI_POSTGRESQL_LISTEN="${PATRONI_POSTGRESQL_LISTEN:-0.0.0.0:5432}"
export PATRONI_POSTGRESQL_CONNECT_ADDRESS="${PATRONI_POSTGRESQL_CONNECT_ADDRESS:-$DOCKER_IP:5432}"
export PATRONI_RESTAPI_LISTEN="${PATRONI_RESTAPI_LISTEN:-0.0.0.0:8008}"
export PATRONI_RESTAPI_CONNECT_ADDRESS="${PATRONI_RESTAPI_CONNECT_ADDRESS:-$DOCKER_IP:8008}"
export PATRONI_REPLICATION_USERNAME="${PATRONI_REPLICATION_USERNAME:-replicator}"
export PATRONI_POSTGRESQL_PGPASS="${PATRONI_POSTGRESQL_PGPASS:-/opt/postgres/.pgpass}"

# Postgres options
export PG_SHARED_BUFFERS="${PG_SHARED_BUFFERS:-2GB}"
export PG_EFFECTIVE_CACHE_SIZE="${PG_EFFECTIVE_CACHE_SIZE:-6GB}"
export PG_MAINTENANCE_WORK_MEM="${PG_MAINTENANCE_WORK_MEM:-512MB}"
export PG_CHECKPOINT_COMPLETION_TARGET="${PG_CHECKPOINT_COMPLETION_TARGET:-0.7}"
export PG_WAL_BUFFERS="${PG_WAL_BUFFERS:-16MB}"
export PG_DEFAULT_STATISTICS_TARGET="${PG_DEFAULT_STATISTICS_TARGET:-100}"
export PG_RANDOM_PAGE_COST="${PG_RANDOM_PAGE_COST:-1.1}"
export PG_EFFECTIVE_IO_CONCURRENCY="${PG_EFFECTIVE_IO_CONCURRENCY:-200}"
export PG_WORK_MEM="${PG_WORK_MEM:-16MB}"
export PG_MIN_WAL_SIZE="${PG_MIN_WAL_SIZE:-1GB}"
export PG_MAX_WAL_SIZE="${PG_MAX_WAL_SIZE:-4GB}"
export PG_MAX_WORKER_PROCESSES="${PG_MAX_WORKER_PROCESSES:-2}"
export PG_MAX_PARALLEL_WORKERS_PER_GATHER="${PG_MAX_PARALLEL_WORKERS_PER_GATHER:-1}"
export PG_MAX_PARALLEL_WORKERS="${PG_MAX_PARALLEL_WORKERS:-2}"
export PG_UNIX_SOCKET_DIRECTORIES="${PG_UNIX_SOCKET_DIRECTORIES:-/tmp}"
export PG_MAX_CONNECTIONS="${PG_MAX_CONNECTIONS:-64}"

log "Starting $PATRONI_SCOPE"

# Activate virtual environment
export PATH="/opt/venv/bin:$PATH"
source /opt/venv/bin/activate

if [ -e $PATRONI_CONFIG_PATH ]
then
  log "Using config $PATRONI_CONFIG_PATH"
else
  log "Create config $PATRONI_CONFIG_PATH from template"
  envsubst < /opt/postgres/config/postgres.template.yml > $PATRONI_CONFIG_PATH
fi

log "Starting patroni"

patroni $PATRONI_CONFIG_PATH
